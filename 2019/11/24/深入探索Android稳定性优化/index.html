<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="default">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="性能优化," />





  <link rel="alternate" href="/rss2.xml" title="Deep into Android" type="application/atom+xml" />






<meta name="description" content="前言成为一名优秀的Android开发，需要一份完备的知识体系，在这里，让我们一起成长为自己所想的那样~。一、正确认识 稳定性很重要，Crash是P0优先级 稳定性可优化的面很广  1.1 稳定性纬度 Crash纬度 性能纬度：启动速度、内存、绘制等等优化方向，相对于Crash来说是次要的 业务高可用纬度  1.2 稳定性优化概述 重在预防、监控必不可少 思考更深一层、重视隐含信息：如解决Cras">
<meta name="keywords" content="性能优化">
<meta property="og:type" content="article">
<meta property="og:title" content="深入探索Android稳定性优化">
<meta property="og:url" content="http://yoursite.com/2019/11/24/深入探索Android稳定性优化/index.html">
<meta property="og:site_name" content="Deep into Android">
<meta property="og:description" content="前言成为一名优秀的Android开发，需要一份完备的知识体系，在这里，让我们一起成长为自己所想的那样~。一、正确认识 稳定性很重要，Crash是P0优先级 稳定性可优化的面很广  1.1 稳定性纬度 Crash纬度 性能纬度：启动速度、内存、绘制等等优化方向，相对于Crash来说是次要的 业务高可用纬度  1.2 稳定性优化概述 重在预防、监控必不可少 思考更深一层、重视隐含信息：如解决Cras">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://gityuan.com/images/stability/app_crash.jpg">
<meta property="og:image" content="http://gityuan.com/images/stability/binder_died.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/JsonChao/Awesome-Android-Notebook/master/screenshots/native_crash_log.png">
<meta property="og:image" content="https://raw.githubusercontent.com/JsonChao/Awesome-Android-Interview/master/screenshot/wexin_play.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/JsonChao/Awesome-Android-Interview/master/screenshot/Apaliy.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/JsonChao/Awesome-Android-Interview/master/screenshot/wexin_qrcode.jpg">
<meta property="og:updated_time" content="2019-11-30T01:18:29.891Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入探索Android稳定性优化">
<meta name="twitter:description" content="前言成为一名优秀的Android开发，需要一份完备的知识体系，在这里，让我们一起成长为自己所想的那样~。一、正确认识 稳定性很重要，Crash是P0优先级 稳定性可优化的面很广  1.1 稳定性纬度 Crash纬度 性能纬度：启动速度、内存、绘制等等优化方向，相对于Crash来说是次要的 业务高可用纬度  1.2 稳定性优化概述 重在预防、监控必不可少 思考更深一层、重视隐含信息：如解决Cras">
<meta name="twitter:image" content="http://gityuan.com/images/stability/app_crash.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '2JGM8QNUKR',
      apiKey: 'ad3d08277d479825f7ef759beadbce0d',
      indexName: 'dicovery',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/11/24/深入探索Android稳定性优化/"/>





  <title>深入探索Android稳定性优化 | Deep into Android</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Deep into Android</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/24/深入探索Android稳定性优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="JsonChao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Deep into Android">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">深入探索Android稳定性优化</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-24T22:45:00+08:00">
                2019-11-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/性能优化/" itemprop="url" rel="index">
                    <span itemprop="name">性能优化</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/11/24/深入探索Android稳定性优化/" class="leancloud_visitors" data-flag-title="深入探索Android稳定性优化">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Visitors&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <hr>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><h3 id="成为一名优秀的Android开发，需要一份完备的知识体系，在这里，让我们一起成长为自己所想的那样-。"><a href="#成为一名优秀的Android开发，需要一份完备的知识体系，在这里，让我们一起成长为自己所想的那样-。" class="headerlink" title="成为一名优秀的Android开发，需要一份完备的知识体系，在这里，让我们一起成长为自己所想的那样~。"></a>成为一名优秀的Android开发，需要一份完备的<a href="https://github.com/JsonChao/Awesome-Android-Exercise" target="_blank" rel="external">知识体系</a>，在这里，让我们一起成长为自己所想的那样~。</h3><h2 id="一、正确认识"><a href="#一、正确认识" class="headerlink" title="一、正确认识"></a>一、正确认识</h2><ul>
<li>稳定性很重要，Crash是P0优先级</li>
<li>稳定性可优化的面很广</li>
</ul>
<h3 id="1-1-稳定性纬度"><a href="#1-1-稳定性纬度" class="headerlink" title="1.1 稳定性纬度"></a>1.1 稳定性纬度</h3><ul>
<li>Crash纬度</li>
<li>性能纬度：启动速度、内存、绘制等等优化方向，相对于Crash来说是次要的</li>
<li>业务高可用纬度</li>
</ul>
<h3 id="1-2-稳定性优化概述"><a href="#1-2-稳定性优化概述" class="headerlink" title="1.2 稳定性优化概述"></a>1.2 稳定性优化概述</h3><ul>
<li>重在预防、监控必不可少</li>
<li>思考更深一层、重视隐含信息：如解决Crash问题时思考是否会引发同一类问题</li>
<li>长效保持需要科学流程</li>
</ul>
<h3 id="1-3-Crash相关指标"><a href="#1-3-Crash相关指标" class="headerlink" title="1.3 Crash相关指标"></a>1.3 Crash相关指标</h3><h4 id="1-3-1-UV、PV"><a href="#1-3-1-UV、PV" class="headerlink" title="1.3.1 UV、PV"></a>1.3.1 UV、PV</h4><ul>
<li>PV（Page View）：访问量</li>
<li>UV（Unique Visitor）：独立访客，0 - 24小时内的同一终端只计算一次</li>
</ul>
<h4 id="1-3-2-UV、PV、启动Crash率"><a href="#1-3-2-UV、PV、启动Crash率" class="headerlink" title="1.3.2 UV、PV、启动Crash率"></a>1.3.2 UV、PV、启动Crash率</h4><ul>
<li>UV Crash率：针对用户使用量的统计，统计一段时间内所有用户发生崩溃的占比</li>
<li>Crash UV / DAU：评估Crash率的影响范围，结合PV</li>
</ul>
<p>注意：沿用同一指标</p>
<ul>
<li>PV Crash率：评估相关Crash影响的严重程度</li>
<li>启动Crash率：影响最严重的Crash，对用户伤害最大，无法通过热修复拯救，需结合客户端容灾</li>
<li>增量、存量Crash率：增量Crash是新版本重点，存量Crash是需要持续啃的硬骨头，优先解决增量、持续跟进存量</li>
</ul>
<h4 id="1-4-Crash率评价"><a href="#1-4-Crash率评价" class="headerlink" title="1.4 Crash率评价"></a>1.4 Crash率评价</h4><ul>
<li>必须在千分之二以下</li>
<li>万分位为优秀</li>
</ul>
<h4 id="1-5-Crash关键问题"><a href="#1-5-Crash关键问题" class="headerlink" title="1.5 Crash关键问题"></a>1.5 Crash关键问题</h4><p>尽可能还原Crash现场:</p>
<ul>
<li>堆栈、设备、OS版本、进程、线程名、Logcat<br>前后台、使用时长、App版本、小版本、渠道<br>CPU架构、内存信息、线程数、资源包信息、用户行为日志</li>
<li>Crash现场信息、Crash Top机型、OS版本、分布版本、区域<br>Crash起始版本、上报趋势、是否新增、持续、量级<br>根据以上信息决定Crash是否需要立马解决以及在哪个版本进行解决</li>
<li>参考Bugly平台的APM后台聚合展示</li>
</ul>
<h4 id="1-6-APM-Crash部分整体架构"><a href="#1-6-APM-Crash部分整体架构" class="headerlink" title="1.6 APM Crash部分整体架构"></a>1.6 APM Crash部分整体架构</h4><h5 id="采集层"><a href="#采集层" class="headerlink" title="采集层"></a>采集层</h5><ul>
<li>错误堆栈</li>
<li>设备信息</li>
<li>行为日志</li>
<li>其它信息</li>
</ul>
<h5 id="处理层"><a href="#处理层" class="headerlink" title="处理层"></a>处理层</h5><ul>
<li>数据清洗</li>
<li>数据聚合</li>
<li>纬度分类</li>
<li>趋势对比</li>
</ul>
<h5 id="展示层"><a href="#展示层" class="headerlink" title="展示层"></a>展示层</h5><ul>
<li>数据还原</li>
<li>纬度信息</li>
<li>起始版本</li>
<li>其它信息</li>
</ul>
<h5 id="报警层"><a href="#报警层" class="headerlink" title="报警层"></a>报警层</h5><ul>
<li>环比：期与上一期进行对比</li>
<li>同比：如本月10号与上月10号</li>
<li>邮件</li>
<li>IM</li>
<li>电话</li>
</ul>
<h5 id="责任归属"><a href="#责任归属" class="headerlink" title="责任归属"></a>责任归属</h5><ul>
<li>设立专项小组轮值</li>
<li>自动匹配责任人</li>
<li>处理流程全纪录</li>
</ul>
<h2 id="二、Crash优化"><a href="#二、Crash优化" class="headerlink" title="二、Crash优化"></a>二、Crash优化</h2><h3 id="2-1-单个Crash处理方案"><a href="#2-1-单个Crash处理方案" class="headerlink" title="2.1 单个Crash处理方案"></a>2.1 单个Crash处理方案</h3><p>1、根据堆栈及现场信息找答案</p>
<ul>
<li>解决90%问题</li>
<li>解决完后需考虑产生Crash深层次的原因</li>
</ul>
<p>2、找共性：机型、OS、实验开关、资源包，考虑影响范围</p>
<p>3、线下复现、远程调试</p>
<h3 id="2-2-Crash率治理方案"><a href="#2-2-Crash率治理方案" class="headerlink" title="2.2 Crash率治理方案"></a>2.2 Crash率治理方案</h3><ul>
<li>1、解决线上常规Crash</li>
<li>2、系统级Crash尝试Hook绕过</li>
<li>3、疑难Crash重点突破或更换方案</li>
</ul>
<h3 id="2-3-Java-Crash"><a href="#2-3-Java-Crash" class="headerlink" title="2.3 Java Crash"></a>2.3 Java Crash</h3><p>出现未捕获异常，导致出现异常退出</p>
<pre><code>Thread.setDefaultUncaughtExceptionHandler()；
</code></pre><p>我们通过设置自定义的UncaughtExceptionHandler，就可以在崩溃发生的时候获取到现场信息。注意，这个钩子是针对单个进程而言的，在多进程的APP中，监控哪个进程，就需要在哪个进程中设置一遍ExceptionHandler。</p>
<p>获取主线程的堆栈信息：</p>
<pre><code>Looper.getMainLooper().getThread().getStackTrace();
</code></pre><p>获取当前线程的堆栈信息：</p>
<pre><code>Thread.currentThread().getStackTrace();
</code></pre><p>获取全部线程的堆栈信息：</p>
<pre><code>Thread.getAllStackTraces();
</code></pre><p>第三方Crash监控工具如Fabric、腾讯Bugly，都是以字符串拼接的方式将数组StackTraceElement[]转换成字符串形式，进行保存、上报或者展示。</p>
<h4 id="2-3-1-如何反混淆上传的堆栈信息？"><a href="#2-3-1-如何反混淆上传的堆栈信息？" class="headerlink" title="2.3.1 如何反混淆上传的堆栈信息？"></a>2.3.1 如何反混淆上传的堆栈信息？</h4><ul>
<li>每次打包生成混淆APK的时候，需要把Mapping文件保存并上传到监控后台；</li>
<li>Android原生的反混淆的工具包是retrace.jar，在监控后台用来实时解析每个上报的崩溃时。它会将Mapping文件进行文本解析和对象实例化，这个过程比较耗时。因此可以将Mapping对象实例进行内存缓存，但为了防止内存泄露和内存过多占用，需要增加定期自动回收的逻辑。</li>
</ul>
<h4 id="2-3-2-获取logcat方法"><a href="#2-3-2-获取logcat方法" class="headerlink" title="2.3.2 获取logcat方法"></a>2.3.2 获取logcat方法</h4><p>logcat日志流程是这样的，应用层 –&gt; liblog.so –&gt; logd，底层使用ring buffer来存储数据。获取的方式有以下三种：</p>
<h5 id="1-通过logcat命令获取。"><a href="#1-通过logcat命令获取。" class="headerlink" title="1. 通过logcat命令获取。"></a>1. 通过logcat命令获取。</h5><ul>
<li>优点：非常简单，兼容性好。</li>
<li>缺点：整个链路比较长，可控性差，失败率高，特别是堆破坏或者堆内存不足时，基本会失败。</li>
</ul>
<h5 id="2-hook-liblog-so实现。通过hook-liblog-so-中-android-log-buf-write-方法，将内容重定向到自己的buffer中。"><a href="#2-hook-liblog-so实现。通过hook-liblog-so-中-android-log-buf-write-方法，将内容重定向到自己的buffer中。" class="headerlink" title="2. hook liblog.so实现。通过hook liblog.so 中__android_log_buf_write 方法，将内容重定向到自己的buffer中。"></a>2. hook liblog.so实现。通过hook liblog.so 中__android_log_buf_write 方法，将内容重定向到自己的buffer中。</h5><ul>
<li>优点：简单，兼容性相对还好。</li>
<li>缺点：要一直打开。</li>
</ul>
<h5 id="3-自定义获取代码。通过移植底层获取logcat的实现，通过socket直接跟logd交互。"><a href="#3-自定义获取代码。通过移植底层获取logcat的实现，通过socket直接跟logd交互。" class="headerlink" title="3. 自定义获取代码。通过移植底层获取logcat的实现，通过socket直接跟logd交互。"></a>3. 自定义获取代码。通过移植底层获取logcat的实现，通过socket直接跟logd交互。</h5><ul>
<li>优点：比较灵活，预先分配好资源，成功率也比较高。</li>
<li>缺点：实现非常复杂</li>
</ul>
<h4 id="2-3-3-获取Java-堆栈"><a href="#2-3-3-获取Java-堆栈" class="headerlink" title="2.3.3 获取Java 堆栈"></a>2.3.3 获取Java 堆栈</h4><p>native崩溃时，通过unwind只能拿到Native堆栈。我们希望可以拿到当时各个线程的Java堆栈。</p>
<h5 id="1-Thread-getAllStackTraces-。"><a href="#1-Thread-getAllStackTraces-。" class="headerlink" title="1. Thread.getAllStackTraces()。"></a>1. Thread.getAllStackTraces()。</h5><p>优点：简单，兼容性好。</p>
<p>缺点：</p>
<ul>
<li>成功率不高，依靠系统接口在极端情况也会失败。</li>
<li>7.0之后这个接口是没有主线程堆栈。</li>
<li>使用Java层的接口需要暂停线程。</li>
</ul>
<h5 id="2-hook-libart-so。通过hook-ThreadList和Thread的函数，获得跟ANR一样的堆栈。为了稳定性，需要在fork的子进程中执行。"><a href="#2-hook-libart-so。通过hook-ThreadList和Thread的函数，获得跟ANR一样的堆栈。为了稳定性，需要在fork的子进程中执行。" class="headerlink" title="2. hook libart.so。通过hook ThreadList和Thread的函数，获得跟ANR一样的堆栈。为了稳定性，需要在fork的子进程中执行。"></a>2. hook libart.so。通过hook ThreadList和Thread的函数，获得跟ANR一样的堆栈。为了稳定性，需要在fork的子进程中执行。</h5><ul>
<li>优点：信息很全，基本跟ANR的日志一样，有native线程状态，锁信息等等。</li>
<li>缺点：黑科技的兼容性问题，失败时可以用Thread.getAllStackTraces()兜底</li>
</ul>
<h4 id="2-3-4-Java-Crash处理流程"><a href="#2-3-4-Java-Crash处理流程" class="headerlink" title="2.3.4 Java Crash处理流程"></a>2.3.4 Java Crash处理流程</h4><p>借用Gityuan流程图如下所示：</p>
<p><img src="http://gityuan.com/images/stability/app_crash.jpg" alt="image"></p>
<p>1、首先发生crash所在进程，在创建之初便准备好了defaultUncaughtHandler，用来来处理Uncaught Exception，并输出当前crash基本信息；</p>
<p>2、调用当前进程中的AMP.handleApplicationCrash；经过binder ipc机制，传递到system_server进程；</p>
<p>3、接下来，进入system_server进程，调用binder服务端执行AMS.handleApplicationCrash；</p>
<p>4、从mProcessNames查找到目标进程的ProcessRecord对象；并将进程crash信息输出到目录/data/system/dropbox；</p>
<p>5、执行makeAppCrashingLocked：</p>
<ul>
<li>创建当前用户下的crash应用的error receiver，并忽略当前应用的广播；</li>
<li>停止当前进程中所有activity中的WMS的冻结屏幕消息，并执行相关一些屏幕相关操作；</li>
</ul>
<p>6、再执行handleAppCrashLocked方法：</p>
<ul>
<li>当1分钟内同一进程连续crash两次时，且非persistent进程，则直接结束该应用所有activity，并杀死该进程以及同一个进程组下的所有进程。然后再恢复栈顶第一个非finishing状态的activity;</li>
<li>当1分钟内同一进程连续crash两次时，且persistent进程，，则只执行恢复栈顶第一个非finishing状态的activity;</li>
<li>当1分钟内同一进程未发生连续crash两次时，则执行结束栈顶正在运行activity的流程。</li>
</ul>
<p>7、通过mUiHandler发送消息SHOW_ERROR_MSG，弹出crash对话框；</p>
<p>8、到此，system_server进程执行完成。回到crash进程开始执行杀掉当前进程的操作；</p>
<p>9、当crash进程被杀，通过binder死亡通知，告知system_server进程来执行appDiedLocked()；</p>
<p>10、最后，执行清理应用相关的activity/service/ContentProvider/receiver组件信息。</p>
<h5 id="补充：binder-死亡通知原理"><a href="#补充：binder-死亡通知原理" class="headerlink" title="补充：binder 死亡通知原理"></a>补充：binder 死亡通知原理</h5><p>流程图如下：</p>
<p><img src="http://gityuan.com/images/stability/binder_died.jpg" alt="image"></p>
<p>由于Crash进程中拥有一个Binder服务端ApplicationThread，而应用进程在创建过程调用attachApplicationLocked()，从而attach到system_server进程，在system_server进程内有一个ApplicationThreadProxy，这是相对应的Binder客户端。当Binder服务端ApplicationThread所在进程(即Crash进程)挂掉后，则Binder客户端能收到相应的死亡通知，从而进入binderDied流程。</p>
<h3 id="2-4-Native-Crash"><a href="#2-4-Native-Crash" class="headerlink" title="2.4 Native Crash"></a>2.4 Native Crash</h3><p>特点:</p>
<ul>
<li>访问非法地址</li>
<li>地址对齐出错</li>
<li>发送程序主动abort</li>
</ul>
<p>上述都会产生相应的signal信号，导致程序异常退出</p>
<h4 id="2-4-1-合格的异常捕获组件"><a href="#2-4-1-合格的异常捕获组件" class="headerlink" title="2.4.1 合格的异常捕获组件"></a>2.4.1 合格的异常捕获组件</h4><ul>
<li>支持在crash时进行更多扩张操作</li>
<li>打印logcat和日志</li>
<li>上报crash次数</li>
<li>对不同crash做不同恢复措施</li>
<li>可以针对业务不断改进的适应</li>
</ul>
<h4 id="2-4-2-现有方案"><a href="#2-4-2-现有方案" class="headerlink" title="2.4.2 现有方案"></a>2.4.2 现有方案</h4><h5 id="Google-Breakpad"><a href="#Google-Breakpad" class="headerlink" title="Google Breakpad"></a>Google Breakpad</h5><ul>
<li>优点：权威、跨平台</li>
<li>缺点：代码体量较大</li>
</ul>
<h5 id="Logcat"><a href="#Logcat" class="headerlink" title="Logcat"></a>Logcat</h5><ul>
<li>优点：利用安卓系统实现</li>
<li>缺点：需要在crash时启动新进程过滤logcat日志，不可靠</li>
</ul>
<h5 id="coffeecatch"><a href="#coffeecatch" class="headerlink" title="coffeecatch"></a>coffeecatch</h5><ul>
<li>优点：实现简洁、改动容易</li>
<li>缺点：有兼容性问题</li>
</ul>
<h4 id="2-4-3-Native崩溃捕获流程"><a href="#2-4-3-Native崩溃捕获流程" class="headerlink" title="2.4.3 Native崩溃捕获流程"></a>2.4.3 Native崩溃捕获流程</h4><h5 id="1、编译端"><a href="#1、编译端" class="headerlink" title="1、编译端"></a>1、编译端</h5><p>编译C/C++需将带符号信息的文件保留下来。</p>
<h5 id="2、客户端"><a href="#2、客户端" class="headerlink" title="2、客户端"></a>2、客户端</h5><p>捕获到崩溃时，将收集到尽可能多的有用信息写入日志文件，然后选择合适的时机上传到服务器。</p>
<h5 id="3、服务端"><a href="#3、服务端" class="headerlink" title="3、服务端"></a>3、服务端</h5><p>读取客户端上报的日志文件，寻找合适的符号文件，生成可读的C/C++调用栈。</p>
<h4 id="2-4-4-Native崩溃捕获的难点"><a href="#2-4-4-Native崩溃捕获的难点" class="headerlink" title="2.4.4 Native崩溃捕获的难点"></a>2.4.4 Native崩溃捕获的难点</h4><p>核心：如何确保客户端在各种极端情况下依然可以生成崩溃日志。</p>
<h5 id="1、文件句柄泄漏，导致创建日志文件失败？"><a href="#1、文件句柄泄漏，导致创建日志文件失败？" class="headerlink" title="1、文件句柄泄漏，导致创建日志文件失败？"></a>1、文件句柄泄漏，导致创建日志文件失败？</h5><p>提前申请文件句柄fd预留。</p>
<h5 id="2、栈溢出导致日志生成失败？"><a href="#2、栈溢出导致日志生成失败？" class="headerlink" title="2、栈溢出导致日志生成失败？"></a>2、栈溢出导致日志生成失败？</h5><ul>
<li>使用额外的栈空间signalstack，避免栈溢出导致进程没有空间创建调用栈执行处理函数。（signalstack：系统会在危险情况下把栈指针指向这个地方，使得可以在一个新的栈上运行信号处理函数）</li>
<li>特殊请求需直接替换当前栈，所以应在堆中预留部分空间。</li>
</ul>
<h5 id="3、堆内存耗尽导致日志生产失败？"><a href="#3、堆内存耗尽导致日志生产失败？" class="headerlink" title="3、堆内存耗尽导致日志生产失败？"></a>3、堆内存耗尽导致日志生产失败？</h5><p>参考Breakpad重新封装Linux Syscall Support的做法以避免直接调用libc去分配堆内存。</p>
<h5 id="4、堆破坏或二次崩溃导致日志生成失败？"><a href="#4、堆破坏或二次崩溃导致日志生成失败？" class="headerlink" title="4、堆破坏或二次崩溃导致日志生成失败？"></a>4、堆破坏或二次崩溃导致日志生成失败？</h5><p>Breakpad使用了fork子进程甚至孙进程的方式去收集崩溃现场，即便出现二次崩溃，也只是这部分信息丢失。</p>
<p>这里说下Breakpad缺点：</p>
<ul>
<li>生成的minidump文件时二进制的，包含过多不重要的信息，导致文件数MB。但minidump可以使用gdb调试、看到传入参数。</li>
</ul>
<p>未来Chromium会使用Crashpad替代Breakpad。</p>
<h5 id="5、想要遵循Android的文本格式并添加更多重要的信息？"><a href="#5、想要遵循Android的文本格式并添加更多重要的信息？" class="headerlink" title="5、想要遵循Android的文本格式并添加更多重要的信息？"></a>5、想要遵循Android的文本格式并添加更多重要的信息？</h5><p>改造Breakpad，增加Logcat信息，Java调用栈信息、其它有用信息。</p>
<h4 id="2-4-5-Native崩溃捕获注册"><a href="#2-4-5-Native崩溃捕获注册" class="headerlink" title="2.4.5 Native崩溃捕获注册"></a>2.4.5 Native崩溃捕获注册</h4><p>一个Native Crash log信息如下：</p>
<p><img src="https://raw.githubusercontent.com/JsonChao/Awesome-Android-Notebook/master/screenshots/native_crash_log.png" alt="image"></p>
<p>堆栈信息中 pc 后面跟的内存地址，就是当前函数的栈地址，我们可以通过下面的命令行得出出错的代码行数</p>
<pre><code>arm-linux-androideabi-addr2line -e 内存地址
</code></pre><p>下面列出全部的信号量以及所代表的含义：</p>
<pre><code>#define SIGHUP 1  // 终端连接结束时发出(不管正常或非正常)
#define SIGINT 2  // 程序终止(例如Ctrl-C)
#define SIGQUIT 3 // 程序退出(Ctrl-\)
#define SIGILL 4 // 执行了非法指令，或者试图执行数据段，堆栈溢出
#define SIGTRAP 5 // 断点时产生，由debugger使用
#define SIGABRT 6 // 调用abort函数生成的信号，表示程序异常
#define SIGIOT 6 // 同上，更全，IO异常也会发出
#define SIGBUS 7 // 非法地址，包括内存地址对齐出错，比如访问一个4字节的整数, 但其地址不是4的倍数
#define SIGFPE 8 // 计算错误，比如除0、溢出
#define SIGKILL 9 // 强制结束程序，具有最高优先级，本信号不能被阻塞、处理和忽略
#define SIGUSR1 10 // 未使用，保留
#define SIGSEGV 11 // 非法内存操作，与 SIGBUS不同，他是对合法地址的非法访问，    比如访问没有读权限的内存，向没有写权限的地址写数据
#define SIGUSR2 12 // 未使用，保留
#define SIGPIPE 13 // 管道破裂，通常在进程间通信产生
#define SIGALRM 14 // 定时信号,
#define SIGTERM 15 // 结束程序，类似温和的 SIGKILL，可被阻塞和处理。通常程序如    果终止不了，才会尝试SIGKILL
#define SIGSTKFLT 16  // 协处理器堆栈错误
#define SIGCHLD 17 // 子进程结束时, 父进程会收到这个信号。
#define SIGCONT 18 // 让一个停止的进程继续执行
#define SIGSTOP 19 // 停止进程,本信号不能被阻塞,处理或忽略
#define SIGTSTP 20 // 停止进程,但该信号可以被处理和忽略
#define SIGTTIN 21 // 当后台作业要从用户终端读数据时, 该作业中的所有进程会收到SIGTTIN信号
#define SIGTTOU 22 // 类似于SIGTTIN, 但在写终端时收到
#define SIGURG 23 // 有紧急数据或out-of-band数据到达socket时产生
#define SIGXCPU 24 // 超过CPU时间资源限制时发出
#define SIGXFSZ 25 // 当进程企图扩大文件以至于超过文件大小资源限制
#define SIGVTALRM 26 // 虚拟时钟信号. 类似于SIGALRM,     但是计算的是该进程占用的CPU时间.
#define SIGPROF 27 // 类似于SIGALRM/SIGVTALRM, 但包括该进程用的CPU时间以及系统调用的时间
#define SIGWINCH 28 // 窗口大小改变时发出
#define SIGIO 29 // 文件描述符准备就绪, 可以开始进行输入/输出操作
#define SIGPOLL SIGIO // 同上，别称
#define SIGPWR 30 // 电源异常
#define SIGSYS 31 // 非法的系统调用
</code></pre><p>一般关注SIGILL, SIGABRT, SIGBUS, SIGFPE, SIGSEGV, SIGSTKFLT, SIGSYS即可。</p>
<p>要订阅异常发生的信号，最简单的做法就是直接用一个循环遍历所有要订阅的信号，对每个信号调用sigaction()。</p>
<p>注意：</p>
<ul>
<li>JNI_OnLoad是最适合安装信号初识函数的地方。</li>
<li>建议在上报时调用Java层的方法统一上报。Native崩溃捕获注册。</li>
</ul>
<h4 id="2-4-6-崩溃分析流程"><a href="#2-4-6-崩溃分析流程" class="headerlink" title="2.4.6 崩溃分析流程"></a>2.4.6 崩溃分析流程</h4><p>首先，应收集崩溃现场的一些信息，如下：</p>
<h5 id="1、崩溃信息"><a href="#1、崩溃信息" class="headerlink" title="1、崩溃信息"></a>1、崩溃信息</h5><ul>
<li>进程名、线程名</li>
<li>崩溃堆栈和类型</li>
<li>有时候也需要知道主线程的调用栈</li>
</ul>
<h5 id="2、系统信息"><a href="#2、系统信息" class="headerlink" title="2、系统信息"></a>2、系统信息</h5><ul>
<li>系统运行日志</li>
</ul>
<pre><code>/system/etc/event-log-tags
</code></pre><ul>
<li>机型、系统、厂商、CPU、ABI、Linux版本等</li>
</ul>
<p>注意寻找共性问题</p>
<ul>
<li>设备状态</li>
<li>是否root</li>
<li>是否是模拟器</li>
</ul>
<h5 id="3、内存信息"><a href="#3、内存信息" class="headerlink" title="3、内存信息"></a>3、内存信息</h5><p><strong>系统剩余内存</strong></p>
<pre><code>/proc/meminfo
</code></pre><p>当系统可用内存小于MemTotal的10%时，OOM、大量GC、系统频繁自杀拉起等问题非常容易出现</p>
<p><strong>应用使用内存</strong></p>
<p>包括Java内存、RSS、PSS</p>
<p>PSS和RSS通过/proc/self/smap计算，可以得到apk、dex、so等更详细的分类统计。</p>
<p><strong>虚拟内存</strong></p>
<p>大小：</p>
<pre><code>/proc/self/status
</code></pre><p>具体分布情况：</p>
<pre><code>/proc/self/maps
</code></pre><p>注意：</p>
<p>对于32位进程，32位CPU，虚拟内存达到3GB就可能会引起内存失败的问题。如果是64位的CPU，虚拟内存一般在3~4GB。如果支持64位进程，虚拟内存就不会成为问题。</p>
<h5 id="4、资源信息"><a href="#4、资源信息" class="headerlink" title="4、资源信息"></a>4、资源信息</h5><p>如果应用堆内存和设备内存比较充足，但还出现内存分配失败，则可能跟资源泄漏有关。</p>
<p><strong>文件句柄fd</strong></p>
<p>限制数：</p>
<pre><code>/proc/self/limits
</code></pre><p>一般单个进程允许打开的最大句柄个数为1024，如果超过800需将所有fd和文件名输出日志进行排查。</p>
<p><strong>线程数</strong></p>
<p>大小：</p>
<pre><code>/proc/self/status
</code></pre><p>一个线程一般占2MB的虚拟内存，线程数超过400个比较危险，需要将所有tid和线程名输出到日志进行排查。</p>
<p><strong>JNI</strong></p>
<p>容易出现引用失效、引用爆表等崩溃。</p>
<p>通过DumpReferenceTables统计JNI的引用表，进一步分析是否出现JNI泄漏等问题。</p>
<p><strong>补充：dumpReferenceTables的出处</strong></p>
<p>在dalvik.system.VMDebug类中，是一个native方法，亦是static方法；在JNI中可以这么调用</p>
<pre><code>jclass vm_class = env-&gt;FindClass(&quot;dalvik/system/VMDebug&quot;);
jmethodID dump_mid = env-&gt;GetStaticMethodID( vm_class, &quot;dumpReferenceTables&quot;, &quot;()V&quot; );
env-&gt;CallStaticVoidMethod( vm_class, dump_mid );
</code></pre><h5 id="5、应用信息"><a href="#5、应用信息" class="headerlink" title="5、应用信息"></a>5、应用信息</h5><ul>
<li>崩溃场景</li>
<li>关键操作路径</li>
<li>其它跟自身应用相关的自定义信息：运行时间、是否加载补丁、是否全新安装或升级。</li>
</ul>
<p>接下来进行崩溃分析：</p>
<h5 id="1、确定重点"><a href="#1、确定重点" class="headerlink" title="1、确定重点"></a>1、确定重点</h5><ul>
<li>确认严重程度</li>
<li>优先解决Top崩溃或对业务有重大影响的崩溃：如启动、支付过程的崩溃</li>
<li>Java崩溃：如果是OOM，需进一步查看日志中的内存信息和资源信息</li>
<li>Native崩溃：查看signal、code、fault addr以及崩溃时的Java堆栈</li>
</ul>
<p>常见的崩溃类型有</p>
<p>SIGSEGV：空指针、非法指针等<br>SIGABRT：ANR、调用abort推出等</p>
<p>如果是ANR，先看主线程堆栈、是否因为锁等待导致，然后看ANR日志中的iowait、CPU、GC、systemserver等信息，确定是I/O问题或CPU竞争问题还是大量GC导致的ANR。</p>
<p>注意：</p>
<p>当从一条崩溃日志中无法看出问题原因时，需要查看相同崩溃点下的更多崩溃日志，或者也可以查看内存信息、资源信息等进行异常排查。</p>
<h5 id="2、查找共性"><a href="#2、查找共性" class="headerlink" title="2、查找共性"></a>2、查找共性</h5><p>机型、系统、ROM、厂商、ABI这些信息都可以作为共性参考，对于下一步复现问题有明确指引。</p>
<h5 id="3、尝试复现"><a href="#3、尝试复现" class="headerlink" title="3、尝试复现"></a>3、尝试复现</h5><p>复现之后再增加日志或使用Debugger、GDB进行调试。如不能复现，可以采用一些高级手段，如xlog日志、远程诊断、动态分析等等。</p>
<p>补充：系统崩溃解决方式</p>
<ul>
<li>1、通过共性信息查找可能的原因</li>
<li>2、尝试使用其它使用方式规避</li>
<li>3、Hook解决</li>
</ul>
<h4 id="2-4-7-实战：使用Breakpad捕获native崩溃"><a href="#2-4-7-实战：使用Breakpad捕获native崩溃" class="headerlink" title="2.4.7 实战：使用Breakpad捕获native崩溃"></a>2.4.7 实战：使用Breakpad捕获native崩溃</h4><p>首先，这里给出《Android开发高手课》张绍文老师写的<a href="https://github.com/AndroidAdvanceWithGeektime/Chapter01" target="_blank" rel="external">crash捕获示例工程</a>，工程里面已经集成了Breakpad 来获取发生 native crash 时候的系统信息和线程堆栈信息。下面来详细介绍下使用Breakpad来分析native崩溃的流程：</p>
<p>1、示例工程是采用cmake的构建方式，所以需要先到Android Studio中SDK Manager中的SDK Tools下下载NDK和cmake。</p>
<p>2、安装实例工程后，点击CRASH按钮产生一个native崩溃。生成的 crash信息，如果授予Sdcard权限会优先存放在/sdcard/crashDump下，便于我们做进一步的分析。反之会放到目录 /data/data/com.dodola.breakpad/files/crashDump中。</p>
<p>3、使用adb pull命令将抓取到的crash日志文件放到电脑本地目录中：</p>
<pre><code>adb pull /sdcard/crashDump/***.dmp &gt; ~/Documents/crash_log.dmp
</code></pre><p>4、下载并编译Breakpad源码，在src/processor目录下找到minidump_stackwalk，使用这个工具将dmp文件转换为txt文件：</p>
<pre><code>// 在项目目录下clone Breakpad仓库
git clone https://github.com/google/breakpad.git

// 切换到Breakpad根目录进行配置、编译
cd breakpad
./configure &amp;&amp; make

// 使用src/processor目录下的minidump_stackwalk工具将dmp文件转换为txt文件
./src/processor/minidump_stackwalk ~/Documents/crashDump/crash_log.dmp &gt;crash_log.txt 
</code></pre><p>5、打开crash_log.txt，可以得到如下内容：</p>
<pre><code>Operating system: Android
                  0.0.0 Linux 4.4.78-perf-g539ee70 #1 SMP PREEMPT Mon Jan 14 17:08:14 CST 2019 aarch64
CPU: arm64
     8 CPUs

GPU: UNKNOWN

Crash reason:  SIGSEGV /SEGV_MAPERR
Crash address: 0x0
Process uptime: not available

Thread 0 (crashed)
 0  libcrash-lib.so + 0x650
</code></pre><p>其中我们需要的关键信息为CPU是arm64的，并且crash的地址为0x650。接下来我们需要将这个地址转换为代码中对应的行。</p>
<p>6、ndk 中提供的addr2line来根据地址进行一个符号反解的过程。</p>
<p>如果是arm64的so使用 $NDKHOME/toolchains/aarch64-linux-android-4.9/prebuilt/darwin-x86_64/bin/aarch64-linux-android-addr2line。</p>
<p>如果是arm的so使用 $NDKHOME/toolchains/arm-linux-androideabi-4.9/prebuilt/darwin-x86_64/bin/arm-linux-androideabi-addr2line。</p>
<p>由crash_log.txt的信息可知，我们机器的cpu架构是arm64的，因此需要使用aarch64-linux-android-addr2line这个命令行工具。该命令的一般使用格式如下：<br>    // 注意：在mac下 ./ 代表执行文件    ./aarch64-linux-android-addr2line -e 对应的.so 需要解析的地址</p>
<p>上述中对应的.so文件在项目编译之后，会出现在Chapter01-master/sample/build/intermediates/merged_native_libs/debug/out/lib/arm64-v8a/libcrash-lib.so这个位置，由于我的手机CPU架构是arm64的，所以这里选择的是arm64-v8a中的libcrash-lib.so。接下来我们使用aarch64-linux-android-addr2line这个命令：</p>
<pre><code>./aarch64-linux-android-addr2line -f -C -e ~/Documents/open-project/Chapter01-master/sample/build/intermediates/merged_native_libs/debug/out/lib/arm64-v8a/libcrash-lib.so 0x650

参数含义：
-e --exe=&lt;executable&gt;：指定需要转换地址的可执行文件名。
-f --functions：在显示文件名、行号输出信息的同时显示函数名信息。
-C --demangle[=style]：将低级别的符号名解码为用户级别的名字。
</code></pre><p>结果输出为：</p>
<pre><code>Crash()
/Users/quchao/Documents/open-project/Chapter01-master/sample/src/main/cpp/crash.cpp:10
</code></pre><p>由此，我们得出crash的代码行为crahs.cpp文件中的第10行，接下来根据项目具体情况进行相应的修改即可。</p>
<p>Tips：这是从事NDK开发（音视频、图像处理、OpenCv、热修复框架开发）同学调试native层错误时经常要使用的技巧，强烈建议熟练掌握。</p>
<h4 id="2-4-8-疑难Crash解决方案"><a href="#2-4-8-疑难Crash解决方案" class="headerlink" title="2.4.8 疑难Crash解决方案"></a>2.4.8 疑难Crash解决方案</h4><h5 id="问题1：如何解决Android-7-0-Toast-BadTokenException？"><a href="#问题1：如何解决Android-7-0-Toast-BadTokenException？" class="headerlink" title="问题1：如何解决Android 7.0 Toast BadTokenException？"></a>问题1：如何解决Android 7.0 Toast BadTokenException？</h5><p>参考Android 8.0 try catch的做法，代理Toast里的mTN（handler）就可以实现捕获异常。</p>
<h5 id="问题2：如果解决-SharedPreference-apply-引起的-ANR-问题"><a href="#问题2：如果解决-SharedPreference-apply-引起的-ANR-问题" class="headerlink" title="问题2：如果解决 SharedPreference apply 引起的 ANR 问题"></a>问题2：如果解决 SharedPreference apply 引起的 ANR 问题</h5><p><strong>apply为什么会引起ANR</strong>？</p>
<p>SP 调用 apply 方法，会创建一个等待锁放到 QueuedWork 中，并将真正数据持久化封装成一个任务放到异步队列中执行，任务执行结束会释放锁。Activity onStop 以及 Service 处理 onStop，onStartCommand 时，执行 QueuedWork.waitToFinish() 等待所有的等待锁释放。</p>
<p><strong>如何解决？</strong></p>
<p>所有此类 ANR 都是经由 QueuedWork.waitToFinish() 触发的，只要在调用此函数之前，将其中保存的队列手动清空即可。</p>
<p>具体是Hook ActivityThrad的Handler变量，拿到此变量后给其设置一个Callback，Handler 的 dispatchMessage 中会先处理 callback。最后在 Callback<br>中调用队列的清理工作，注意队列清理需要反射调用 QueuedWork。</p>
<p>注意：</p>
<p>apply 机制本身的失败率就比较高（1.8%左右），清理等待锁队列对持久化造成的影响不大。</p>
<h5 id="问题3：如何解决TimeoutExceptin异常？"><a href="#问题3：如何解决TimeoutExceptin异常？" class="headerlink" title="问题3：如何解决TimeoutExceptin异常？"></a>问题3：如何解决TimeoutExceptin异常？</h5><p>它是由系统的FinalizerWatchdogDaemon抛出来的。</p>
<p>这里首先介绍下看门狗 WatchDog，它 的作用是监控重要服务的运行状态，当重要服务停止时，发生 Timeout 异常崩溃，WatchDog 负责将应用重启。而当关闭 WatchDog（执行stop（）方法）后，当重要服务停止时，也不会发生 Timeout 异常，是一种通过非正常手段防止异常发生的方法。</p>
<p><strong>规避方案：</strong></p>
<p>stop方法，在Android 6.0之前会有线程同步问题。<br>因为6.0之前调用threadToStop的interrupt方法是没有加锁的，所以可能会有线程同步的问题。</p>
<p>注意：Stop的时候有一定概率导致即使没有超时也会报timeoutexception。</p>
<p>缺点：</p>
<p>只是为了避免上报异常采取的一种hack方案，并没有真正解决引起finialize超市的问题。</p>
<h5 id="问题4：如何解决输入法的内存泄漏？"><a href="#问题4：如何解决输入法的内存泄漏？" class="headerlink" title="问题4：如何解决输入法的内存泄漏？"></a>问题4：如何解决输入法的内存泄漏？</h5><p>通过反射将输入法的两个View置空。</p>
<h4 id="2-4-9-进程保活"><a href="#2-4-9-进程保活" class="headerlink" title="2.4.9 进程保活"></a>2.4.9 进程保活</h4><p>请参考<a href="https://jsonchao.github.io/2019/11/10/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2Android%E5%90%AF%E5%8A%A8%E9%80%9F%E5%BA%A6%E4%BC%98%E5%8C%96/" target="_blank" rel="external">深入探索Android启动速度优化</a>一文。</p>
<p>这里补充一个方案，利用SyncAdapter提高进程优先级，它是Android系统提供一个账号同步机制，它属于核心进程级别，而使用了SyncAdapter的进程优先级本身也会提高，使用方式请Google，关联SyncAdapter后，进程的优先级变为1，仅低于前台正在运行的进程，因此可以降低应用被系统杀掉的概率。</p>
<h3 id="2-5-总结"><a href="#2-5-总结" class="headerlink" title="2.5 总结"></a>2.5 总结</h3><ul>
<li>重在预防：重视应用的整个流程、包括开发人员的培训、编译检查、静态扫描、规范的测试、灰度、发布流程等</li>
<li>不应该随意使用try catch去隐藏问题，而应该从源头入手，了解崩溃的本质原因，保证后面的运行流程。</li>
<li>解决崩溃的过程应该由点到面，考虑一类崩溃怎么解决。</li>
<li>崩溃与内存、卡顿、I/O内存紧密相关</li>
</ul>
<h2 id="三、ANR优化"><a href="#三、ANR优化" class="headerlink" title="三、ANR优化"></a>三、ANR优化</h2><h3 id="3-1-ANR监控实现方式"><a href="#3-1-ANR监控实现方式" class="headerlink" title="3.1 ANR监控实现方式"></a>3.1 ANR监控实现方式</h3><h4 id="1、使用FileObserver监听-data-anr-traces-txt的变化"><a href="#1、使用FileObserver监听-data-anr-traces-txt的变化" class="headerlink" title="1、使用FileObserver监听 /data/anr/traces.txt的变化"></a>1、使用FileObserver监听 /data/anr/traces.txt的变化</h4><p>缺点：高版本ROM需要root权限</p>
<p>解决方案：海外Google Play服务、国内Hardcoder</p>
<h4 id="2、监控消息队列的运行时间（WatchDog）"><a href="#2、监控消息队列的运行时间（WatchDog）" class="headerlink" title="2、监控消息队列的运行时间（WatchDog）"></a>2、监控消息队列的运行时间（WatchDog）</h4><h5 id="卡顿监控原理："><a href="#卡顿监控原理：" class="headerlink" title="卡顿监控原理："></a>卡顿监控原理：</h5><p>利用主线程的消息队列处理机制，应用发生卡顿，一定是在dispatchMessage中执行了耗时操作。我们通过给主线程的Looper设置一个Printer，打点统计dispatchMessage方法执行的时间，如果超出阀值，表示发生卡顿，则dump出各种信息，提供开发者分析性能瓶颈。</p>
<p>为卡顿监控代码增加ANR的线程监控，在发送消息时，在ANR线程中保存一个状态，主线程消息执行完后再Reset标志位。如果在ANR线程中收到发送消息后，超过一定时间没有复位，就可以任务发生了ANR。</p>
<p>缺点：</p>
<ul>
<li>无法准确判断是否真正出现ANR，只能说明APP发生了UI阻塞，需要进行二次校验。校验的方式就是等待手机系统出现发生了Error的进程，并且Error类型是NOT_RESPONDING（值为2）。<br>在每次出现ANR弹框前，Native层都会发出signal为SIGNAL_QUIT（值为3）的信号事件，也可以监听此信号。</li>
<li>无法得到完整ANR日志</li>
<li>隶属于卡顿优化的方式</li>
</ul>
<h4 id="需要考虑应用退出场景"><a href="#需要考虑应用退出场景" class="headerlink" title="需要考虑应用退出场景"></a>需要考虑应用退出场景</h4><ul>
<li>主动自杀</li>
<li>Process.killProcess()、exit()等。</li>
<li>崩溃</li>
<li>系统重启</li>
<li>系统异常、断电、用户重启等：通过比较应用开机运行时间是否比之前记录的值更小。</li>
<li>被系统杀死</li>
<li>被LMK杀死、从系统的任务管理器中划掉等。</li>
</ul>
<p>注意：由于traces.txt上传比较耗时，所以一般线下采用，线上建议综合ProcessErrorStateInfo和出现ANR时的堆栈信息来实现ANR的实时上传。</p>
<h3 id="3-2-ANR优化"><a href="#3-2-ANR优化" class="headerlink" title="3.2 ANR优化"></a>3.2 ANR优化</h3><p>ANR发生原因：没有在规定的时间内完成要完成的事情。</p>
<h4 id="3-2-1-ANR分类"><a href="#3-2-1-ANR分类" class="headerlink" title="3.2.1 ANR分类"></a>3.2.1 ANR分类</h4><h5 id="发生场景"><a href="#发生场景" class="headerlink" title="发生场景"></a>发生场景</h5><ul>
<li>Activity onCreate方法或Input事件超过5s没有完成</li>
<li>BroadcastReceiver前台10s，后台60s</li>
<li>ContentProvider 在publish过超时10s;</li>
<li>Service前台20s，后台200s</li>
</ul>
<h5 id="发生原因"><a href="#发生原因" class="headerlink" title="发生原因"></a>发生原因</h5><ul>
<li>主线程有耗时操作</li>
<li>复杂布局</li>
<li>IO操作</li>
<li>被子线程同步锁block</li>
<li>被Binder对端block</li>
<li>Binder被占满导致主线程无法和SystemServer通信</li>
<li>得不到系统资源（CPU/RAM/IO）</li>
</ul>
<p>从进程角度看发生原因有：</p>
<ul>
<li>当前进程：主线程本身耗时或者主线程的消息队列存在耗时操作、主线程被本进程的其它子线程所blocked</li>
<li>远端进程：binder call、socket通信</li>
</ul>
<p>Andorid系统监测ANR的核心原理是消息调度和超时处理。</p>
<h4 id="3-2-2-ANR排查流程"><a href="#3-2-2-ANR排查流程" class="headerlink" title="3.2.2 ANR排查流程"></a>3.2.2 ANR排查流程</h4><h5 id="1、Log获取"><a href="#1、Log获取" class="headerlink" title="1、Log获取"></a>1、Log获取</h5><p>1、抓取bugreport</p>
<pre><code>adb shell bugreport &gt; bugreport.txt
</code></pre><p>2、直接导出/data/anr/traces.txt文件</p>
<pre><code>adb pull /data/anr/traces.txt trace.txt
</code></pre><h5 id="2、搜索“ANR-in”处log关键点解读"><a href="#2、搜索“ANR-in”处log关键点解读" class="headerlink" title="2、搜索“ANR in”处log关键点解读"></a>2、搜索“ANR in”处log关键点解读</h5><ul>
<li>发生时间（可能会延时10-20s）</li>
<li>pid：当pid=0，说明在ANR之前，进程就被LMK杀死或出现了Crash，所以无法接受到系统的广播或者按键消息，因此会出现ANR</li>
<li><p>cpu负载Load: 7.58 / 6.21 / 4.83</p>
<p>  代表此时一分钟有平均有7.58个进程在等待<br>  1、5、15分钟内系统的平均负荷<br>  当系统负荷持续大于1.0，必须将值降下来<br>  当系统负荷达到5.0，表面系统有很严重的问题</p>
</li>
<li><p>cpu使用率</p>
</li>
</ul>
<pre><code>CPU usage from 18101ms to 0ms ago
28% 2085/system_server: 18% user + 10% kernel / faults: 8689 minor 24 major
11% 752/android.hardware.sensors@1.0-service: 4% user + 6.9% kernel / faults: 2 minor
9.8% 780/surfaceflinger: 6.2% user + 3.5% kernel / faults: 143 minor 4 major
</code></pre><p>上述表示Top进程的cpu占用情况。</p>
<p>注意：如果CPU使用量很少，说明主线程可能阻塞。</p>
<h5 id="3、在bugreport-txt中根据pid和发生时间搜索到阻塞的log处"><a href="#3、在bugreport-txt中根据pid和发生时间搜索到阻塞的log处" class="headerlink" title="3、在bugreport.txt中根据pid和发生时间搜索到阻塞的log处"></a>3、在bugreport.txt中根据pid和发生时间搜索到阻塞的log处</h5><pre><code>----- pid 10494 at 2019-11-18 15:28:29 -----
</code></pre><h5 id="4、往下翻找到“main”线程则可看到对应的阻塞log"><a href="#4、往下翻找到“main”线程则可看到对应的阻塞log" class="headerlink" title="4、往下翻找到“main”线程则可看到对应的阻塞log"></a>4、往下翻找到“main”线程则可看到对应的阻塞log</h5><pre><code>&quot;main&quot; prio=5 tid=1 Sleeping
| group=&quot;main&quot; sCount=1 dsCount=0 flags=1 obj=0x746bf7f0 self=0xe7c8f000
| sysTid=10494 nice=-4 cgrp=default sched=0/0 handle=0xeb6784a4
| state=S schedstat=( 5119636327 325064933 4204 ) utm=460 stm=51 core=4 HZ=100
| stack=0xff575000-0xff577000 stackSize=8MB
| held mutexes=
</code></pre><p>关键字段含义：</p>
<ul>
<li>tid：线程号</li>
<li>sysTid：主进程线程号和进程号相同</li>
<li>Waiting/Sleeping：各种线程状态</li>
<li>nice：nice值越小，则优先级越高，-17~16</li>
<li>schedstat：Running、Runable时间(ns)与Switch次数</li>
<li>utm：该线程在用户态的执行时间(jiffies)</li>
<li>stm：该线程在内核态的执行时间(jiffies)</li>
<li>sCount：该线程被挂起的次数</li>
<li>dsCount：该线程被调试器挂起的次数</li>
<li>self：线程本身的地址</li>
</ul>
<h5 id="其它分析方法：Java线程调用分析方法"><a href="#其它分析方法：Java线程调用分析方法" class="headerlink" title="其它分析方法：Java线程调用分析方法"></a>其它分析方法：Java线程调用分析方法</h5><ul>
<li>先使用jps命令列出当前系统中运行的所有Java虚拟机进程，拿到应用进程的pid。</li>
<li>然后再使用jstack命令查看该进程中所有线程的状态以及调用关系，以及一些简单的分析结果。</li>
</ul>
<h5 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h5><p>1、sp调用apply导致anr问题？</p>
<p>虽然apply并不会阻塞主线程，但是会将等待时间转嫁到主线程。</p>
<p>2、检测运行期间是否发生过异常退出？</p>
<p>在应用启动时设定一个标志，在主动自杀或崩溃后更新标志 ，下次启动时检测此标志即可判断。</p>
<h3 id="3-2-4-理解ANR的触发流程"><a href="#3-2-4-理解ANR的触发流程" class="headerlink" title="3.2.4 理解ANR的触发流程"></a>3.2.4 理解ANR的触发流程</h3><p>broadcast跟service超时机制大抵相同，但有一个非常隐蔽的技能点，那就是通过静态注册的广播超时会受SharedPreferences(简称SP)的影响。</p>
<p>当SP有未同步到磁盘的工作，则需等待其完成，才告知系统已完成该广播。并且只有XML静态注册的广播超时检测过程会考虑是否有SP尚未完成，动态广播并不受其影响。</p>
<ul>
<li><p>对于Service, Broadcast, Input发生ANR之后,最终都会调用AMS.appNotResponding;</p>
</li>
<li><p>对于provider,在其进程启动时publish过程可能会出现ANR, 则会直接杀进程以及清理相应信息,而不会弹出ANR的对话框.</p>
</li>
<li><p>对于输入事件发生ANR，首先会调用InputMonitor.notifyANR，最终也会调用AMS.appNotResponding。</p>
</li>
</ul>
<h4 id="3-2-4-1-AMS-appNotResponding流程"><a href="#3-2-4-1-AMS-appNotResponding流程" class="headerlink" title="3.2.4.1 AMS.appNotResponding流程"></a>3.2.4.1 AMS.appNotResponding流程</h4><ul>
<li>输出ANR Reason信息到EventLog. 也就是说ANR触发的时间点最接近的就是EventLog中输出的am_anr信息;</li>
<li>收集并输出重要进程列表中的各个线程的traces信息，该方法较耗时; </li>
<li>输出当前各个进程的CPU使用情况以及CPU负载情况;</li>
<li>将traces文件和 CPU使用情况信息保存到dropbox，即data/system/dropbox目录（ANR信息最为重要的信息）</li>
<li>根据进程类型,来决定直接后台杀掉,还是弹框告知用户.</li>
</ul>
<h4 id="3-2-4-2-AMS-dumpStackTraces流程"><a href="#3-2-4-2-AMS-dumpStackTraces流程" class="headerlink" title="3.2.4.2 AMS.dumpStackTraces流程"></a>3.2.4.2 AMS.dumpStackTraces流程</h4><p>1、收集firstPids进程的stacks：</p>
<ul>
<li>第一个是发生ANR进程；</li>
<li>第二个是system_server；</li>
<li>其余的是mLruProcesses中所有的persistent进程。</li>
</ul>
<p>2、收集Native进程的stacks。(dumpNativeBacktraceToFile)</p>
<ul>
<li>依次是mediaserver,sdcard,surfaceflinger进程。</li>
</ul>
<p>3、收集lastPids进程的stacks：</p>
<ul>
<li>依次输出CPU使用率top 5的进程；</li>
</ul>
<p>注意：</p>
<p>上述导出每个进程trace时，进程之间会休眠200ms。</p>
<h2 id="四、移动端业务高可用方案建设"><a href="#四、移动端业务高可用方案建设" class="headerlink" title="四、移动端业务高可用方案建设"></a>四、移动端业务高可用方案建设</h2><h3 id="2-3-1-业务高可用重要性"><a href="#2-3-1-业务高可用重要性" class="headerlink" title="2.3.1 业务高可用重要性"></a>2.3.1 业务高可用重要性</h3><ul>
<li>高可用</li>
<li>性能</li>
<li>业务</li>
<li>侧重于用户功能完整可用</li>
<li>真实影响收入</li>
</ul>
<h3 id="2-3-2-业务高可用方案建设"><a href="#2-3-2-业务高可用方案建设" class="headerlink" title="2.3.2 业务高可用方案建设"></a>2.3.2 业务高可用方案建设</h3><ul>
<li>数据采集</li>
<li>梳理项目主流程、核心路径、关键节点</li>
<li>Aop自动采集、统一上报</li>
<li>报警策略：阈值报警、趋势报警、特定指标报警、直接上报（或底阈值）</li>
<li>异常监控</li>
<li>单点追查：需要针对性分析的特定问题，全量日志回捞，专项分析</li>
<li>兜底策略</li>
<li>配置中心、功能开关</li>
<li>跳转分发中心（组件化路由）</li>
</ul>
<h3 id="2-3-3-移动端容灾方案"><a href="#2-3-3-移动端容灾方案" class="headerlink" title="2.3.3 移动端容灾方案"></a>2.3.3 移动端容灾方案</h3><p>灾包括：</p>
<ul>
<li>性能异常</li>
<li>业务异常</li>
</ul>
<p>传统流程：</p>
<p>用户反馈、重新打包、渠道更新、不可接受。</p>
<h4 id="2-3-3-1-容灾方案建设："><a href="#2-3-3-1-容灾方案建设：" class="headerlink" title="2.3.3.1 容灾方案建设："></a>2.3.3.1 容灾方案建设：</h4><p><strong>功能开关</strong></p>
<p>配置中心，服务端下发配置控制</p>
<p>针对场景：</p>
<ul>
<li>功能新增</li>
<li>代码改动</li>
</ul>
<p><strong>统跳中心</strong></p>
<ul>
<li>界面切换通过路由，路由决定是否重定向</li>
<li>Native Bug不能热修复则跳转到临时H5页面</li>
</ul>
<p><strong>动态化修复</strong></p>
<ul>
<li>热修复能力，可监控、灰度、回滚、清除</li>
</ul>
<p><strong>推拉结合、多场景调用保证到达率</strong></p>
<p><strong>Weex、RN增量更新</strong></p>
<p><strong>安全模式</strong></p>
<p>微信读书、蘑菇街、淘宝、天猫等“重运营”的APP都使用了安全模式保障客户端启动流程，启动失败后给用户自救机会。先介绍一下它的核心特点：</p>
<ul>
<li>根据Crash信息自动恢复，多次启动失败重置应用为安装初始状态</li>
<li>严重Bug可阻塞性热修复</li>
</ul>
<p><strong>安全模式设计</strong></p>
<p>配置后台：统一的配置后台，具备灰度发布机制</p>
<p>1、客户端能力：</p>
<ul>
<li>在APP连续Crash的情况下具备分级、无感自修复能力</li>
<li>具备同步热修复能力</li>
<li>具备指定触发某项特定功能的能力</li>
<li>具体功能注册能力，方便后期扩展安全模式</li>
</ul>
<p>2、数据统计及告警</p>
<ul>
<li>统一的数据平台</li>
<li>监控告警功能，及时发现问题</li>
<li>查看热修复成功率等数据</li>
</ul>
<p>3、快速测试</p>
<ul>
<li>优化预发布环境下测试</li>
<li>优化回归验证安全模式难点等</li>
</ul>
<p><strong>天猫安全模式原理</strong></p>
<p>1、如何判断异常退出？</p>
<p>APP启动时记录一个flag值，满足以下条件时，将flag值清空</p>
<ul>
<li>APP正常启动10秒</li>
<li>用户正常退出应用</li>
<li>用户主动从前台切换到后台</li>
</ul>
<p>如果在启动阶段发生异常，则flag值不会清空，通过flag值就可以判断客户端是否异常退出，每次异常退出，flag值都+1。</p>
<p>2、安全模式的分级执行策略</p>
<p>分为两级安全模式，连续Crash 2次为一级安全模式，连续Crash 2次及以上为二级安全模式。</p>
<p>业务线可以在一级安全模式中注册行为，比如清空缓存数据，再进入该模式时，会使用注册行为尝试修复客户端<br>如果一级安全模式无法修复APP，则进入二级安全模式将APP恢复到初次安装状态，并将Document、Library、Cache三个根目录清空。</p>
<p>3、热修复执行策略</p>
<p>只要发现配置中需要热修复，APP就会同步阻塞进行热修复,保证修复的及时性</p>
<p>4、灰度方案</p>
<p>灰度时，配置中会包含灰度、正式两份配置及其灰度概率<br>APP根据特定算法算出自己是否满足灰度条件，则使用灰度配置</p>
<p><strong>易用性考量</strong></p>
<p>1、接入成本</p>
<p>完善文档、接口简洁</p>
<p>2、统一配置后台</p>
<p>可按照APP、版本配置</p>
<p>3、定制性</p>
<p>支持定制功能，让接入方来决定具体行为</p>
<p>4、灰度机制</p>
<p>5、数据分析</p>
<p>采用统一数据平台，为安全模式改进提供依据</p>
<p>6、快速测试</p>
<p>创建更多的针对性测试案例，如模拟连续Crash</p>
<p><strong>异常熔断</strong></p>
<ul>
<li>多次请求失败则可让网络库主动拒绝请求</li>
</ul>
<p><strong>容灾方案集合路径</strong></p>
<p>功能开关 -&gt; 统跳中心 -&gt; 动态修复 -&gt; 安全模式</p>
<h2 id="五、稳定性长效治理"><a href="#五、稳定性长效治理" class="headerlink" title="五、稳定性长效治理"></a>五、稳定性长效治理</h2><h3 id="开发阶段"><a href="#开发阶段" class="headerlink" title="开发阶段"></a>开发阶段</h3><ul>
<li>统一编码规范、增强编码功底、技术评审、CodeReview机制</li>
<li>架构优化</li>
<li>能力收敛</li>
<li>统一容错：如在网络库utils中统一对返回信息进行预校验，如不合法就直接不走接下来的流程。</li>
</ul>
<h3 id="测试阶段"><a href="#测试阶段" class="headerlink" title="测试阶段"></a>测试阶段</h3><ul>
<li>功能测试、自动化测试、回归测试、覆盖安装</li>
<li>特殊场景、机型等边界测试：如服务端返回异常数据、服务端宕机</li>
<li>云测平台：提供更全面的机型进行测试</li>
</ul>
<h3 id="合码阶段"><a href="#合码阶段" class="headerlink" title="合码阶段"></a>合码阶段</h3><ul>
<li>编译检测、静态扫描</li>
<li>预编译流程、主流程自动回归</li>
</ul>
<h3 id="发布阶段"><a href="#发布阶段" class="headerlink" title="发布阶段"></a>发布阶段</h3><ul>
<li>多轮灰度</li>
<li>分场景、纬度全面覆盖</li>
</ul>
<h3 id="运维阶段"><a href="#运维阶段" class="headerlink" title="运维阶段"></a>运维阶段</h3><ul>
<li>灵敏监控</li>
<li>回滚、降级策略</li>
<li>热修复、本地容灾方案</li>
</ul>
<h2 id="六、稳定性优化问题"><a href="#六、稳定性优化问题" class="headerlink" title="六、稳定性优化问题"></a>六、稳定性优化问题</h2><h3 id="1、你们做了哪些稳定性方面的优化？"><a href="#1、你们做了哪些稳定性方面的优化？" class="headerlink" title="1、你们做了哪些稳定性方面的优化？"></a>1、你们做了哪些稳定性方面的优化？</h3><ul>
<li>Crash专项优化</li>
<li>性能稳定性优化</li>
<li>业务稳定性优化</li>
</ul>
<p>根据以上三方面的优化我们搭建了移动端的高可用平台。</p>
<h3 id="2、性能稳定性是怎么做的？"><a href="#2、性能稳定性是怎么做的？" class="headerlink" title="2、性能稳定性是怎么做的？"></a>2、性能稳定性是怎么做的？</h3><ul>
<li>全面的性能优化：启动速度、内存优化、绘制优化</li>
<li>线下发现问题、优化为主</li>
<li>线上监控为主</li>
<li>Crash专项优化</li>
</ul>
<h3 id="3、业务稳定性如何保障？"><a href="#3、业务稳定性如何保障？" class="headerlink" title="3、业务稳定性如何保障？"></a>3、业务稳定性如何保障？</h3><ul>
<li>数据采集 + 报警</li>
<li>需要对项目的主流程与核心路径进行埋点监控，</li>
<li>同时还需知道每一步发生了多少异常，这样，我们就知道了所有业务流程的转换率以及相应界面的转换率</li>
<li>结合大盘，如果转换率低于某个值，进行报警</li>
<li>异常监控 + 单点追查</li>
<li>兜底策略</li>
</ul>
<h3 id="4、如果发送了异常情况，怎么快速止损？"><a href="#4、如果发送了异常情况，怎么快速止损？" class="headerlink" title="4、如果发送了异常情况，怎么快速止损？"></a>4、如果发送了异常情况，怎么快速止损？</h3><ul>
<li>功能开关</li>
<li>统跳中心</li>
<li>动态修复：热修复、资源包更新</li>
<li>自主修复：安全模式</li>
</ul>
<h2 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a>七、总结</h2><p>Android稳定性优化是一个需要长期投入，持续运营和维护的一个过程，上文中我们不仅深入探讨了Java Crash、Native Crash和ANR的解决流程及方案，还分析了其内部实现原理和监控流程。到这里，可以看到，要想做好稳定性优化，我们必须对虚拟机运行、Linux信号处理和内存分配有一定程度的了解，只有深入了解这些底层知识，我们才能比别人设计出更好的稳定性优化方案。</p>
<h5 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h5><hr>
<p>1、《Android性能优化最佳实践》第五章 稳定性优化 </p>
<p>2、<a href="https://coding.imooc.com/class/308.html" target="_blank" rel="external">慕课网之国内Top团队大牛带你玩转Android性能分析与优化 第十一章 App稳定性优化</a></p>
<p>3、<a href="https://time.geekbang.org/column/article/70966" target="_blank" rel="external">极客时间之Android开发高手课 崩溃优化</a> </p>
<p>4、<a href="https://mp.weixin.qq.com/s/g-WzYF3wWAljok1XjPoo7w?" target="_blank" rel="external">Android 平台 Native 代码的崩溃捕获机制及实现</a></p>
<p>5、<a href="https://mp.weixin.qq.com/s__biz=MzUxMzcxMzE5Ng==&amp;mid=2247488429&amp;idx=1&amp;sn=448b414a0424d06855359b3eb2ba8569&amp;source=41#wechat_redirect" target="_blank" rel="external">安全模式：天猫App启动保护实践</a></p>
<p>6、<a href="https://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&amp;mid=2651748107&amp;idx=1&amp;sn=55dff1b286e92cfb6aaee776df8ec89e&amp;chksm=bd12ae468a652750a7624c30eca56f6f83347b16cdfb9153b647c6e5229a822b16724a1bbd9d&amp;scene=38#wechat_redirect" target="_blank" rel="external">美团外卖Android Crash治理之路</a> （进阶）</p>
<p>7、<a href="https://mp.weixin.qq.com/s/PoWPWy3cXFlG1nohgJTJgw" target="_blank" rel="external">海神平台Crash监控SDK（Android）开发经验总结</a> </p>
<p>8、<a href="https://mp.weixin.qq.com/s?__biz=MzAxNzMxNzk5OQ==&amp;mid=2649485876&amp;idx=1&amp;sn=29ead87814c62a9b3e80cd6ada51e13c&amp;chksm=83f83b34b48fb2225db860a290b4e7ee3b30475d887c2b38e8e29881b297c3cdb5c6d44deaed&amp;scene=38#wechat_redirect" target="_blank" rel="external">Android Native Crash 收集</a> </p>
<p>9、<a href="http://gityuan.com/2016/06/24/app-crash/" target="_blank" rel="external">理解Android Crash处理流程</a></p>
<p>10、<a href="https://www.jianshu.com/p/30c1a5ad63a3" target="_blank" rel="external">Android应用ANR分析</a> </p>
<p>11、<a href="http://gityuan.com/2016/07/02/android-anr/" target="_blank" rel="external">理解Android ANR的触发原理</a></p>
<p>12、<a href="http://gityuan.com/2017/01/01/input-anr/" target="_blank" rel="external">Input系统—ANR原理分析</a></p>
<p>13、<a href="https://www.jianshu.com/p/ad1a84b6ec69" target="_blank" rel="external">ANR监测机制</a> </p>
<p>14、<a href="http://gityuan.com/2016/07/02/android-anr/" target="_blank" rel="external">理解Android ANR的触发原理</a> </p>
<p>15、<a href="http://gityuan.com/2016/12/02/app-not-response/" target="_blank" rel="external">理解Android ANR的信息收集过程</a> </p>
<p>16、<a href="https://www.jianshu.com/p/18f16aba79dd" target="_blank" rel="external">应用与系统稳定性第一篇—ANR问题分析的一般套路</a></p>
<p>17、<a href="https://www.jianshu.com/p/545e5e7bbf94" target="_blank" rel="external">巧妙定位ANR问题</a> </p>
<p>18、<a href="https://mp.weixin.qq.com/s/IFgXvPdiEYDs5cDriApkxQ" target="_blank" rel="external">剖析 SharedPreference apply 引起的 ANR 问题</a> </p>
<p>19、<a href="https://www.mkssoftware.com/docs/man5/siginfo_t.5.asp" target="_blank" rel="external">Linux错误信号</a></p>
<h2 id="赞赏"><a href="#赞赏" class="headerlink" title="赞赏"></a>赞赏</h2><p>如果这个库对您有很大帮助，您愿意支持这个项目的进一步开发和这个项目的持续维护。你可以扫描下面的二维码，让我喝一杯咖啡或啤酒。非常感谢您的捐赠。谢谢！</p>
<div align="center"><br><img src="https://raw.githubusercontent.com/JsonChao/Awesome-Android-Interview/master/screenshot/wexin_play.jpg" width="20%"><img src="https://raw.githubusercontent.com/JsonChao/Awesome-Android-Interview/master/screenshot/Apaliy.jpg" width="20%"><br></div>


<hr>
<h2 id="Contanct-Me"><a href="#Contanct-Me" class="headerlink" title="Contanct Me"></a>Contanct Me</h2><h3 id="●-微信："><a href="#●-微信：" class="headerlink" title="●  微信："></a>●  微信：</h3><blockquote>
<p>欢迎关注我的微信：<code>bcce5360</code>  </p>
</blockquote>
<h3 id="●-微信群："><a href="#●-微信群：" class="headerlink" title="●  微信群："></a>●  微信群：</h3><blockquote>
<p><strong>微信群如果不能扫码加入，麻烦大家想进微信群的朋友们，加我微信拉你进群。</strong></p>
</blockquote>
<div align="center"><br><img src="https://raw.githubusercontent.com/JsonChao/Awesome-Android-Interview/master/screenshot/wexin_qrcode.jpg" width="35%"><br></div>


<h3 id="●-QQ群："><a href="#●-QQ群：" class="headerlink" title="●  QQ群："></a>●  QQ群：</h3><blockquote>
<p>2千人QQ群，<strong>Awesome-Android学习交流群，QQ群号：959936182</strong>， 欢迎大家加入~</p>
</blockquote>
<h3 id="About-me"><a href="#About-me" class="headerlink" title="About me"></a>About me</h3><ul>
<li><h4 id="Email-chao-qu521-gmail-com"><a href="#Email-chao-qu521-gmail-com" class="headerlink" title="Email: chao.qu521@gmail.com"></a>Email: <a href="">chao.qu521@gmail.com</a></h4></li>
<li><h4 id="Blog-https-jsonchao-github-io"><a href="#Blog-https-jsonchao-github-io" class="headerlink" title="Blog: https://jsonchao.github.io/"></a>Blog: <a href="https://jsonchao.github.io/" target="_blank" rel="external">https://jsonchao.github.io/</a></h4></li>
<li><h4 id="掘金-https-juejin-im-user-5a3ba9375188252bca050ade"><a href="#掘金-https-juejin-im-user-5a3ba9375188252bca050ade" class="headerlink" title="掘金: https://juejin.im/user/5a3ba9375188252bca050ade"></a>掘金: <a href="https://juejin.im/user/5a3ba9375188252bca050ade" target="_blank" rel="external">https://juejin.im/user/5a3ba9375188252bca050ade</a></h4></li>
</ul>
<h4 id="很感谢您阅读这篇文章，希望您能将它分享给您的朋友或技术群，这对我意义重大。"><a href="#很感谢您阅读这篇文章，希望您能将它分享给您的朋友或技术群，这对我意义重大。" class="headerlink" title="很感谢您阅读这篇文章，希望您能将它分享给您的朋友或技术群，这对我意义重大。"></a>很感谢您阅读这篇文章，希望您能将它分享给您的朋友或技术群，这对我意义重大。</h4><h4 id="希望我们能成为朋友，在-Github、掘金上一起分享知识。"><a href="#希望我们能成为朋友，在-Github、掘金上一起分享知识。" class="headerlink" title="希望我们能成为朋友，在 Github、掘金上一起分享知识。"></a>希望我们能成为朋友，在 <a href="https://github.com/JsonChao" target="_blank" rel="external">Github</a>、<a href="https://juejin.im/user/5a3ba9375188252bca050ade" target="_blank" rel="external">掘金</a>上一起分享知识。</h4>
      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.png" alt="JsonChao Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/性能优化/" rel="tag"># 性能优化</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/11/10/深入探索Android启动速度优化/" rel="next" title="深入探索Android启动速度优化">
                <i class="fa fa-chevron-left"></i> 深入探索Android启动速度优化
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/29/深入探索Android内存优化/" rel="prev" title="深入探索Android内存优化">
                深入探索Android内存优化 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div id="lv-container" data-id="city" data-uid="MTAyMC8zMzg1Mi8xMDQwNQ==">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="JsonChao" />
            
              <p class="site-author-name" itemprop="name">JsonChao</p>
              <p class="site-description motion-element" itemprop="description">Persist + Plan = Growing</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/rss2.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/JsonChao" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://mail.google.com/mail/u/0/#inbox" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-globe"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/5a3ba9375188252bca050ade" target="_blank" title="JueJin">
                      
                        <i class="fa fa-fw fa-globe"></i>JueJin</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Manito Link
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://wanandroid.com/" title="WanAndroid" target="_blank">WanAndroid</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://hencoder.com/" title="HenCoder" target="_blank">HenCoder</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.trinea.cn/" title="Trinea" target="_blank">Trinea</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://stormzhang.com/" title="stromzhang" target="_blank">stromzhang</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.hensen.site/" title="Hensen" target="_blank">Hensen</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://liuwangshu.cn/" title="刘望舒" target="_blank">刘望舒</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://zhuanlan.zhihu.com/baron/" title="张磊" target="_blank">张磊</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://kymjs.com/" title="张涛" target="_blank">张涛</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.piasy.com/" title="Piasy" target="_blank">Piasy</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.lmj.wiki/" title="ANLY" target="_blank">ANLY</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://glanwang.com/" title="Glan" target="_blank">Glan</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://huangjunbin.com/" title="黄俊彬" target="_blank">黄俊彬</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://droidyue.com/" title="技术小黑屋" target="_blank">技术小黑屋</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://gityuan.com/" title="gityuan" target="_blank">gityuan</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.gcssloop.com/#blog" title="gcsslop" target="_blank">gcsslop</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#成为一名优秀的Android开发，需要一份完备的知识体系，在这里，让我们一起成长为自己所想的那样-。"><span class="nav-number">1.0.1.</span> <span class="nav-text">成为一名优秀的Android开发，需要一份完备的知识体系，在这里，让我们一起成长为自己所想的那样~。</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一、正确认识"><span class="nav-number">1.1.</span> <span class="nav-text">一、正确认识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-稳定性纬度"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1 稳定性纬度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-稳定性优化概述"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2 稳定性优化概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-Crash相关指标"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.3 Crash相关指标</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-1-UV、PV"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">1.3.1 UV、PV</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-2-UV、PV、启动Crash率"><span class="nav-number">1.1.3.2.</span> <span class="nav-text">1.3.2 UV、PV、启动Crash率</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-4-Crash率评价"><span class="nav-number">1.1.3.3.</span> <span class="nav-text">1.4 Crash率评价</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-5-Crash关键问题"><span class="nav-number">1.1.3.4.</span> <span class="nav-text">1.5 Crash关键问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-6-APM-Crash部分整体架构"><span class="nav-number">1.1.3.5.</span> <span class="nav-text">1.6 APM Crash部分整体架构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#采集层"><span class="nav-number">1.1.3.5.1.</span> <span class="nav-text">采集层</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#处理层"><span class="nav-number">1.1.3.5.2.</span> <span class="nav-text">处理层</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#展示层"><span class="nav-number">1.1.3.5.3.</span> <span class="nav-text">展示层</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#报警层"><span class="nav-number">1.1.3.5.4.</span> <span class="nav-text">报警层</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#责任归属"><span class="nav-number">1.1.3.5.5.</span> <span class="nav-text">责任归属</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、Crash优化"><span class="nav-number">1.2.</span> <span class="nav-text">二、Crash优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-单个Crash处理方案"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1 单个Crash处理方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Crash率治理方案"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2 Crash率治理方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-Java-Crash"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3 Java Crash</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-如何反混淆上传的堆栈信息？"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">2.3.1 如何反混淆上传的堆栈信息？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-获取logcat方法"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">2.3.2 获取logcat方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-通过logcat命令获取。"><span class="nav-number">1.2.3.2.1.</span> <span class="nav-text">1. 通过logcat命令获取。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-hook-liblog-so实现。通过hook-liblog-so-中-android-log-buf-write-方法，将内容重定向到自己的buffer中。"><span class="nav-number">1.2.3.2.2.</span> <span class="nav-text">2. hook liblog.so实现。通过hook liblog.so 中__android_log_buf_write 方法，将内容重定向到自己的buffer中。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-自定义获取代码。通过移植底层获取logcat的实现，通过socket直接跟logd交互。"><span class="nav-number">1.2.3.2.3.</span> <span class="nav-text">3. 自定义获取代码。通过移植底层获取logcat的实现，通过socket直接跟logd交互。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-获取Java-堆栈"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">2.3.3 获取Java 堆栈</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-Thread-getAllStackTraces-。"><span class="nav-number">1.2.3.3.1.</span> <span class="nav-text">1. Thread.getAllStackTraces()。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-hook-libart-so。通过hook-ThreadList和Thread的函数，获得跟ANR一样的堆栈。为了稳定性，需要在fork的子进程中执行。"><span class="nav-number">1.2.3.3.2.</span> <span class="nav-text">2. hook libart.so。通过hook ThreadList和Thread的函数，获得跟ANR一样的堆栈。为了稳定性，需要在fork的子进程中执行。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-4-Java-Crash处理流程"><span class="nav-number">1.2.3.4.</span> <span class="nav-text">2.3.4 Java Crash处理流程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#补充：binder-死亡通知原理"><span class="nav-number">1.2.3.4.1.</span> <span class="nav-text">补充：binder 死亡通知原理</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-Native-Crash"><span class="nav-number">1.2.4.</span> <span class="nav-text">2.4 Native Crash</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-1-合格的异常捕获组件"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">2.4.1 合格的异常捕获组件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-2-现有方案"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">2.4.2 现有方案</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Google-Breakpad"><span class="nav-number">1.2.4.2.1.</span> <span class="nav-text">Google Breakpad</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Logcat"><span class="nav-number">1.2.4.2.2.</span> <span class="nav-text">Logcat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#coffeecatch"><span class="nav-number">1.2.4.2.3.</span> <span class="nav-text">coffeecatch</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-3-Native崩溃捕获流程"><span class="nav-number">1.2.4.3.</span> <span class="nav-text">2.4.3 Native崩溃捕获流程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1、编译端"><span class="nav-number">1.2.4.3.1.</span> <span class="nav-text">1、编译端</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2、客户端"><span class="nav-number">1.2.4.3.2.</span> <span class="nav-text">2、客户端</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3、服务端"><span class="nav-number">1.2.4.3.3.</span> <span class="nav-text">3、服务端</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-4-Native崩溃捕获的难点"><span class="nav-number">1.2.4.4.</span> <span class="nav-text">2.4.4 Native崩溃捕获的难点</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1、文件句柄泄漏，导致创建日志文件失败？"><span class="nav-number">1.2.4.4.1.</span> <span class="nav-text">1、文件句柄泄漏，导致创建日志文件失败？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2、栈溢出导致日志生成失败？"><span class="nav-number">1.2.4.4.2.</span> <span class="nav-text">2、栈溢出导致日志生成失败？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3、堆内存耗尽导致日志生产失败？"><span class="nav-number">1.2.4.4.3.</span> <span class="nav-text">3、堆内存耗尽导致日志生产失败？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4、堆破坏或二次崩溃导致日志生成失败？"><span class="nav-number">1.2.4.4.4.</span> <span class="nav-text">4、堆破坏或二次崩溃导致日志生成失败？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5、想要遵循Android的文本格式并添加更多重要的信息？"><span class="nav-number">1.2.4.4.5.</span> <span class="nav-text">5、想要遵循Android的文本格式并添加更多重要的信息？</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-5-Native崩溃捕获注册"><span class="nav-number">1.2.4.5.</span> <span class="nav-text">2.4.5 Native崩溃捕获注册</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-6-崩溃分析流程"><span class="nav-number">1.2.4.6.</span> <span class="nav-text">2.4.6 崩溃分析流程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1、崩溃信息"><span class="nav-number">1.2.4.6.1.</span> <span class="nav-text">1、崩溃信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2、系统信息"><span class="nav-number">1.2.4.6.2.</span> <span class="nav-text">2、系统信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3、内存信息"><span class="nav-number">1.2.4.6.3.</span> <span class="nav-text">3、内存信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4、资源信息"><span class="nav-number">1.2.4.6.4.</span> <span class="nav-text">4、资源信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5、应用信息"><span class="nav-number">1.2.4.6.5.</span> <span class="nav-text">5、应用信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1、确定重点"><span class="nav-number">1.2.4.6.6.</span> <span class="nav-text">1、确定重点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2、查找共性"><span class="nav-number">1.2.4.6.7.</span> <span class="nav-text">2、查找共性</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3、尝试复现"><span class="nav-number">1.2.4.6.8.</span> <span class="nav-text">3、尝试复现</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-7-实战：使用Breakpad捕获native崩溃"><span class="nav-number">1.2.4.7.</span> <span class="nav-text">2.4.7 实战：使用Breakpad捕获native崩溃</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-8-疑难Crash解决方案"><span class="nav-number">1.2.4.8.</span> <span class="nav-text">2.4.8 疑难Crash解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#问题1：如何解决Android-7-0-Toast-BadTokenException？"><span class="nav-number">1.2.4.8.1.</span> <span class="nav-text">问题1：如何解决Android 7.0 Toast BadTokenException？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#问题2：如果解决-SharedPreference-apply-引起的-ANR-问题"><span class="nav-number">1.2.4.8.2.</span> <span class="nav-text">问题2：如果解决 SharedPreference apply 引起的 ANR 问题</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#问题3：如何解决TimeoutExceptin异常？"><span class="nav-number">1.2.4.8.3.</span> <span class="nav-text">问题3：如何解决TimeoutExceptin异常？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#问题4：如何解决输入法的内存泄漏？"><span class="nav-number">1.2.4.8.4.</span> <span class="nav-text">问题4：如何解决输入法的内存泄漏？</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-9-进程保活"><span class="nav-number">1.2.4.9.</span> <span class="nav-text">2.4.9 进程保活</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-总结"><span class="nav-number">1.2.5.</span> <span class="nav-text">2.5 总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、ANR优化"><span class="nav-number">1.3.</span> <span class="nav-text">三、ANR优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-ANR监控实现方式"><span class="nav-number">1.3.1.</span> <span class="nav-text">3.1 ANR监控实现方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1、使用FileObserver监听-data-anr-traces-txt的变化"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">1、使用FileObserver监听 /data/anr/traces.txt的变化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2、监控消息队列的运行时间（WatchDog）"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">2、监控消息队列的运行时间（WatchDog）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#卡顿监控原理："><span class="nav-number">1.3.1.2.1.</span> <span class="nav-text">卡顿监控原理：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#需要考虑应用退出场景"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">需要考虑应用退出场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-ANR优化"><span class="nav-number">1.3.2.</span> <span class="nav-text">3.2 ANR优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-ANR分类"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">3.2.1 ANR分类</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#发生场景"><span class="nav-number">1.3.2.1.1.</span> <span class="nav-text">发生场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#发生原因"><span class="nav-number">1.3.2.1.2.</span> <span class="nav-text">发生原因</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-ANR排查流程"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">3.2.2 ANR排查流程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1、Log获取"><span class="nav-number">1.3.2.2.1.</span> <span class="nav-text">1、Log获取</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2、搜索“ANR-in”处log关键点解读"><span class="nav-number">1.3.2.2.2.</span> <span class="nav-text">2、搜索“ANR in”处log关键点解读</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3、在bugreport-txt中根据pid和发生时间搜索到阻塞的log处"><span class="nav-number">1.3.2.2.3.</span> <span class="nav-text">3、在bugreport.txt中根据pid和发生时间搜索到阻塞的log处</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4、往下翻找到“main”线程则可看到对应的阻塞log"><span class="nav-number">1.3.2.2.4.</span> <span class="nav-text">4、往下翻找到“main”线程则可看到对应的阻塞log</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#其它分析方法：Java线程调用分析方法"><span class="nav-number">1.3.2.2.5.</span> <span class="nav-text">其它分析方法：Java线程调用分析方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#问题："><span class="nav-number">1.3.2.2.6.</span> <span class="nav-text">问题：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-4-理解ANR的触发流程"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.2.4 理解ANR的触发流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-4-1-AMS-appNotResponding流程"><span class="nav-number">1.3.3.1.</span> <span class="nav-text">3.2.4.1 AMS.appNotResponding流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-4-2-AMS-dumpStackTraces流程"><span class="nav-number">1.3.3.2.</span> <span class="nav-text">3.2.4.2 AMS.dumpStackTraces流程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、移动端业务高可用方案建设"><span class="nav-number">1.4.</span> <span class="nav-text">四、移动端业务高可用方案建设</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-1-业务高可用重要性"><span class="nav-number">1.4.1.</span> <span class="nav-text">2.3.1 业务高可用重要性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-2-业务高可用方案建设"><span class="nav-number">1.4.2.</span> <span class="nav-text">2.3.2 业务高可用方案建设</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-3-移动端容灾方案"><span class="nav-number">1.4.3.</span> <span class="nav-text">2.3.3 移动端容灾方案</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-1-容灾方案建设："><span class="nav-number">1.4.3.1.</span> <span class="nav-text">2.3.3.1 容灾方案建设：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、稳定性长效治理"><span class="nav-number">1.5.</span> <span class="nav-text">五、稳定性长效治理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#开发阶段"><span class="nav-number">1.5.1.</span> <span class="nav-text">开发阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试阶段"><span class="nav-number">1.5.2.</span> <span class="nav-text">测试阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#合码阶段"><span class="nav-number">1.5.3.</span> <span class="nav-text">合码阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发布阶段"><span class="nav-number">1.5.4.</span> <span class="nav-text">发布阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#运维阶段"><span class="nav-number">1.5.5.</span> <span class="nav-text">运维阶段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#六、稳定性优化问题"><span class="nav-number">1.6.</span> <span class="nav-text">六、稳定性优化问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1、你们做了哪些稳定性方面的优化？"><span class="nav-number">1.6.1.</span> <span class="nav-text">1、你们做了哪些稳定性方面的优化？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2、性能稳定性是怎么做的？"><span class="nav-number">1.6.2.</span> <span class="nav-text">2、性能稳定性是怎么做的？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3、业务稳定性如何保障？"><span class="nav-number">1.6.3.</span> <span class="nav-text">3、业务稳定性如何保障？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4、如果发送了异常情况，怎么快速止损？"><span class="nav-number">1.6.4.</span> <span class="nav-text">4、如果发送了异常情况，怎么快速止损？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#七、总结"><span class="nav-number">1.7.</span> <span class="nav-text">七、总结</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#参考链接："><span class="nav-number">1.7.0.0.1.</span> <span class="nav-text">参考链接：</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#赞赏"><span class="nav-number">1.8.</span> <span class="nav-text">赞赏</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Contanct-Me"><span class="nav-number">1.9.</span> <span class="nav-text">Contanct Me</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#●-微信："><span class="nav-number">1.9.1.</span> <span class="nav-text">●  微信：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#●-微信群："><span class="nav-number">1.9.2.</span> <span class="nav-text">●  微信群：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#●-QQ群："><span class="nav-number">1.9.3.</span> <span class="nav-text">●  QQ群：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#About-me"><span class="nav-number">1.9.4.</span> <span class="nav-text">About me</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Email-chao-qu521-gmail-com"><span class="nav-number">1.9.4.1.</span> <span class="nav-text">Email: chao.qu521@gmail.com</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Blog-https-jsonchao-github-io"><span class="nav-number">1.9.4.2.</span> <span class="nav-text">Blog: https://jsonchao.github.io/</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#掘金-https-juejin-im-user-5a3ba9375188252bca050ade"><span class="nav-number">1.9.4.3.</span> <span class="nav-text">掘金: https://juejin.im/user/5a3ba9375188252bca050ade</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#很感谢您阅读这篇文章，希望您能将它分享给您的朋友或技术群，这对我意义重大。"><span class="nav-number">1.9.4.4.</span> <span class="nav-text">很感谢您阅读这篇文章，希望您能将它分享给您的朋友或技术群，这对我意义重大。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#希望我们能成为朋友，在-Github、掘金上一起分享知识。"><span class="nav-number">1.9.4.5.</span> <span class="nav-text">希望我们能成为朋友，在 Github、掘金上一起分享知识。</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JsonChao</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>







        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  
    

    
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2155025"></script>
      <!-- UY END -->
    
  





  










   
   
     
   
   
  
     
</div>
<!-- City版安装代码已完成 -->
   
 

   
     
   
  
       <div id="lv-container" data-id="city" data-uid="MTAyMC8zMzg1Mi8xMDQwNQ==">
       <script type="text/javascript">
          (function(d, s) {
              var j, e = d.getElementsByTagName(s)[0];
              if (typeof LivereTower === 'function') { return; }
              j = d.createElement(s);
              j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
              j.async = true;
              e.parentNode.insertBefore(j, e);
          })(document, 'script');
       </script>
       <noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
       <!-- UY END -->
   
 
  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("2wtHdVd6zid7kU6YQKIqsHU5-gzGzoHsz", "eLibBRhSAsSoX1JbTMJH6ka3");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
